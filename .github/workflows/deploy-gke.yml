name: Phase 5 - CI/CD Backend to GKE

on:
  push:
    branches:
      - main
    paths:
      - "**.java"
      - "**.xml"
      - "**.properties"
      - "**.yml"
      - "Dockerfile"
      - "k8s/**"
      - "!vm-deployment/**"  # Exclude VM deployment files

env:
  GCP_PROJECT_ID: dev-ops-475910
  GKE_CLUSTER: task-cluster
  GKE_ZONE: asia-south1-b
  ARTIFACT_REGISTRY_REGION: asia-south1
  REPOSITORY: task-repo-rajinie
  IMAGE_NAME: task-api
  NAMESPACE: task-api

jobs:
  build-push-deploy:
    name: Build, Push, and Deploy Backend to GKE
    runs-on: ubuntu-latest
    environment: gke-deploy
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1. AUTHENTICATION & SDK SETUP ---
      - name: "Authenticate to GCP and Setup SDK"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Configure Docker to use gcloud as a credential helper"
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev

      # --- 2. BUILD APPLICATION ---
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # --- 3. BUILD & PUSH DOCKER IMAGE ---
      - name: Build and Push Docker Image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_PATH="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          # Build image with both SHA tag and latest tag
          docker build -t $IMAGE_PATH:$IMAGE_TAG -t $IMAGE_PATH:latest .

          # Push both tags
          docker push $IMAGE_PATH:$IMAGE_TAG
          docker push $IMAGE_PATH:latest

      # --- 4. DEPLOY TO GKE ---
      - name: Set up GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Update Kubernetes manifests and Deploy
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_PATH="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"

          echo "ğŸ‰ Backend Build Complete!"
          echo "ğŸ“¦ Docker Image: $IMAGE_PATH:$IMAGE_TAG"  
          echo "ğŸš€ Image pushed to Artifact Registry successfully"
          echo ""
          echo "â„¹ï¸  Next Steps:"
          echo "   1. Infrastructure team will deploy this image to GKE"
          echo "   2. Monitor deployment in the infrastructure repository" 
          echo "   3. Verify API at: http://136.110.145.6/api/tasks"

      - name: Verify Image in Registry
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_PATH="${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          echo "ğŸ” Verifying backend image exists in registry..."
          gcloud container images describe $IMAGE_PATH:$IMAGE_TAG --format="value(image_summary.digest)" || echo "âš ï¸ Image verification failed - check registry permissions"

      - name: Check Current Application Status
        run: |
          echo "ğŸ“Š Current Application Status:"
          kubectl get pods -n task-api -l app=backend --no-headers 2>/dev/null | wc -l > /tmp/backend_pods || echo "0" > /tmp/backend_pods
          BACKEND_PODS=$(cat /tmp/backend_pods)

          if [ "$BACKEND_PODS" -gt 0 ]; then
            echo "âœ… Backend pods running: $BACKEND_PODS"
            echo "ğŸ”„ Infrastructure team can update deployment with new image"
          else
            echo "âš ï¸ No backend pods found - initial deployment needed"
          fi
