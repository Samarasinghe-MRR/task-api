name: ðŸ§© Phase 2: Deploy Spring Boot to GCP VM

on:
  push:
    branches:
      - main
    paths:
      - '**.java'  # Trigger only when backend code changes

jobs:
  build-and-deploy-vm:
    name: Build, Package, and Deploy Backend
    runs-on: ubuntu-latest
    environment: vm-deploy  # Environment should be inside the job
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AUTHENTICATION STEP ---
      - name: "Authenticate to GCP"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}"

      # --- INSTALL CLOUD SDK AND SET PROJECT CONTEXT ---
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and Package Spring Boot
        run: mvn clean package -DskipTests
          
      - name: Deploy via SSH to GCP VM
        run: |
          # Find the JAR file
          JAR_FILE=$(find target -name '*.jar' -print -quit)
          
          # Transfer the JAR file using gcloud compute scp
          echo "Transferring new JAR file..."
          gcloud compute scp "$JAR_FILE" ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }}:~/backend/task-api.jar \
            --zone ${{ secrets.GCP_VM_ZONE }}
          
          # Restart the service using gcloud compute ssh
          echo "Restarting task-api service..."
          gcloud compute ssh ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }} \
            --zone ${{ secrets.GCP_VM_ZONE }} \
            --command="sudo systemctl restart task-api.service && sudo systemctl status task-api.service"
