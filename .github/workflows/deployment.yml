name: Deploy Spring Boot to GCP VM

on:
  push:
    branches:
      - main
    paths:
      - "**.java"
      - "**.xml"
      - "**.properties"
      - "**.yml"

jobs:
  build-and-deploy-vm:
    name: Build, Package, and Deploy Backend
    runs-on: ubuntu-latest
    environment: vm-deploy
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- NEW: AUTHENTICATION STEP ---
      - name: "Authenticate to GCP"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}"

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build and Package Spring Boot
        run: mvn clean package -DskipTests

      # --- NEW: FILE TRANSFER STEP (Using gcloud scp) ---
      - name: Transfer JAR file to VM
        run: |
          JAR_FILE=$(find target -name '*.jar' -print -quit) # Find the compiled JAR

          # Use gcloud compute scp for reliable transfer, authenticated by the previous step
          gcloud compute scp "$JAR_FILE" ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }}:~/backend/task-api.jar \
            --zone ${{ secrets.GCP_VM_ZONE }}

      - name: Restart task-api service via SSH
        uses: google-github-actions/ssh@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          instance_name: ${{ secrets.GCP_VM_INSTANCE_NAME }}
          zone: ${{ secrets.GCP_VM_ZONE }}
          user: ${{ secrets.VM_USERNAME }}
          # Only run remote commands here
          command: |
            echo "Restarting task-api service..."
            sudo systemctl restart task-api.service
            sudo systemctl status task-api.service
