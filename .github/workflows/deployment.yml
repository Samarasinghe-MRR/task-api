name: ðŸ§© Phase 2: Deploy Spring Boot to GCP VM

on:
  push:
    branches:
      - main
    paths:
      - '**.java'
      - '**.xml'
      - '**.properties'
      - '**.yml'

jobs:
  build-and-deploy-vm:
    name: Build, Package, and Deploy Backend
    runs-on: ubuntu-latest
    environment: vm-deploy
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and Package Spring Boot
        run: mvn clean package -DskipTests
        
      - name: Find JAR file
        run: |
          echo "Built JAR files:"
          ls -la target/*.jar
          echo "JAR_FILE=$(ls target/*.jar | head -1)" >> $GITHUB_ENV
          
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Deploy to GCP VM
        run: |
          # Add VM to known hosts
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts
          
          # Transfer JAR file
          scp ${{ env.JAR_FILE }} ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_IP }}:~/backend/task-api.jar
          
          # Deploy on remote server
          ssh ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_IP }} << 'EOF'
            # Create backend directory if it doesn't exist
            mkdir -p ~/backend
            
            # Stop the service if running
            sudo systemctl stop task-api.service || true
            
            # Backup old JAR (if exists)
            if [ -f ~/backend/task-api-old.jar ]; then
              rm ~/backend/task-api-old.jar
            fi
            if [ -f ~/backend/task-api.jar ]; then
              mv ~/backend/task-api.jar ~/backend/task-api-old.jar
            fi
            
            # Move new JAR to correct location
            mv ~/backend/task-api.jar ~/backend/task-api-new.jar
            mv ~/backend/task-api-new.jar ~/backend/task-api.jar
            
            # Set executable permissions
            chmod +x ~/backend/task-api.jar
            
            # Start the service
            sudo systemctl start task-api.service
            sudo systemctl enable task-api.service
            
            # Check service status
            sleep 5
            sudo systemctl status task-api.service
            
            echo "âœ… Backend deployed successfully!"
          EOF