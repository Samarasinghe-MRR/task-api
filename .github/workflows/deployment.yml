name: Deploy Spring Boot to GCP VM

on:
  push:
    branches:
      - main
    paths:
      - "**.java"
      - "**.xml"
      - "**.properties"
      - "**.yml"

jobs:
  build-and-deploy-vm:
    name: Build, Package, and Deploy Backend
    runs-on: ubuntu-latest
    environment: vm-deploy
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build and Package Spring Boot
        run: mvn clean package -DskipTests

      - name: Deploy via SSH to GCP VM
        uses: google-github-actions/ssh@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          instance_name: ${{ secrets.GCP_VM_INSTANCE_NAME }}
          zone: ${{ secrets.GCP_VM_ZONE }}
          user: ${{ secrets.VM_USERNAME }}
          command: |
            echo "Transferring new JAR file..."
            scp ./target/*.jar ${{ secrets.VM_USERNAME }}@${{ secrets.GCP_VM_INSTANCE_NAME }}:~/backend/task-api.jar

            echo "Restarting task-api service..."
            sudo systemctl restart task-api.service
            sudo systemctl status task-api.service
